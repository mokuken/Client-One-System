<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chats</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            height: 100vh;
            background: linear-gradient(90deg, rgba(204,254,216,1) 0%, rgba(148,185,255,1) 100%);
            font-family: Georgia, 'Times New Roman', Times, serif;
        }
        .navbar { display:flex; justify-content:space-between; align-items:center; height:10vh; padding:0 100px; background:#fff; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        .content { display:flex; width:100%; height:90vh; padding:30px 40px; align-items:stretch; }
        .main { background:#fff; width:100%; border-radius:10px; padding:20px; display:flex; flex-direction:column; min-height:0 }
        .messenger { display:flex; flex:1 1 auto; gap:20px; min-height:320px; min-width:0 }
        .people-list { width:28%; min-width:200px; background:#f7fbff; border-radius:8px; padding:12px; box-shadow:0 2px 8px rgba(0,0,0,0.04); overflow-y:auto }
        .people-list .person { display:flex; gap:12px; padding:10px; align-items:center; border-radius:8px; cursor:pointer }
        .people-list img.avatar { width:48px; height:48px; border-radius:50%; object-fit:cover }
        .chat-window { flex:1; display:flex; flex-direction:column; background:linear-gradient(180deg,#fff,#fbfdff); border-radius:8px; overflow:hidden; min-height:0 }
        .chat-header { padding:12px 16px; border-bottom:1px solid #eef3f8; display:flex; align-items:center; gap:12px }
        .chat-messages { padding:18px; flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:12px }
        .message { max-width:70%; padding:10px 14px; border-radius:14px; box-shadow:0 1px 2px rgba(0,0,0,0.04) }
        .message.incoming { background:#f1f5ff; align-self:flex-start }
        .message.outgoing { background:#2193b0; color:#fff; align-self:flex-end }
        .message .time { display:block; font-size:0.75rem; opacity:0.7; margin-top:6px }
        .message-input { padding:10px; border-top:1px solid #eef3f8; display:flex; gap:8px; align-items:center }
        .message-input input[type="text"] { flex:1; padding:10px 12px; border-radius:8px; border:1px solid #dfe9f3 }
        .message-input button { padding:10px 14px; border-radius:8px; border:none; background:#2193b0; color:#fff; cursor:pointer; font-weight:700 }
        @media (max-width:900px){ .people-list{display:none} }
    </style>
</head>
<body>
    {% if session.user_id %}
        {% include 'partials/navbarLoggedInCustomer.html' %}
    {% elif session.owner_id %}
        {% include 'partials/navbarLoggedInOwner.html' %}
    {% else %}
        {% include 'partials/navbar.html' %}
    {% endif %}
    <div class="content">
        {% include 'partials/user_sidebar.html' %}
        <div class="main">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h1>Chats</h1>
                <input type="text" placeholder="Search..." style="width:30%;padding:10px;border-radius:5px;border:1px solid #ccc;"/>
            </div>

            <div class="messenger">
                <div class="people-list">
                    {% if conversations and conversations|length > 0 %}
                        {% for conv in conversations %}
                            <div class="person" data-conversation-id="{{ conv.id }}" data-owner-id="{{ conv.owner_id }}">
                                <img class="avatar" src="{{ url_for('static', filename=conv.partner_avatar) if conv.partner_avatar else 'https://via.placeholder.com/48' }}" alt="avatar">
                                <div class="meta">
                                    <div class="name">{{ conv.partner_name }}</div>
                                    <div class="preview">{{ conv.last_text or 'Start a conversation' }}</div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div style="padding:12px;color:#666">You have no conversations yet. Click Message on a resort to start one.</div>
                    {% endif %}
                </div>

                <div class="chat-window">
                    <div class="chat-header">
                        <img id="chatAvatar" src="https://via.placeholder.com/48" alt="chat avatar" style="width:40px;height:40px;border-radius:50%">
                        <div>
                            <div id="chatTitle" style="font-weight:700">Conversation</div>
                            <div id="chatSubtitle" style="font-size:0.85rem;color:#666">Messages</div>
                        </div>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <!-- messages loaded here -->
                    </div>

                    <div class="message-input">
                        <input id="messageText" type="text" placeholder="Type a message...">
                        <button id="sendBtn">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function(){
            const chatMessages = document.getElementById('chatMessages');
            const sendBtn = document.getElementById('sendBtn');
            const msgInput = document.getElementById('messageText');

            function getQueryParam(name){ return new URLSearchParams(window.location.search).get(name); }
            let conversationId = getQueryParam('conversation_id');

            function scrollToBottom(){ chatMessages.scrollTop = chatMessages.scrollHeight; }

            async function loadMessages(){
                if(!conversationId) return;
                try{
                    const res = await fetch('/api/conversation/' + conversationId + '/messages');
                    const data = await res.json();
                    if(data && data.success){
                        chatMessages.innerHTML = '';
                        data.messages.forEach(m => {
                            const el = document.createElement('div');
                            el.className = 'message ' + (m.sender === 'user' ? 'outgoing' : 'incoming');
                            el.innerHTML = (m.text) + '<span class="time">' + new Date(m.created_at).toLocaleString() + '</span>';
                            chatMessages.appendChild(el);
                        });
                        scrollToBottom();
                    }
                } catch(e){ console.error('loadMessages', e); }
            }

            async function sendMessage(){
                if(!conversationId){ alert('No conversation selected'); return; }
                const text = msgInput.value && msgInput.value.trim();
                if(!text) return;
                try{
                    const res = await fetch('/api/conversation/' + conversationId + '/message', {
                        method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ text })
                    });
                    const data = await res.json();
                    if(data && data.success){ msgInput.value = ''; await loadMessages(); }
                    else { alert(data.message || 'Failed to send message'); }
                } catch(e){ console.error('sendMessage', e); alert('Failed to send message'); }
            }

            // clicking a person starts/loads a conversation
            document.querySelectorAll('.people-list .person').forEach(el => {
                el.addEventListener('click', async () => {
                    const ownerId = el.getAttribute('data-owner-id');
                    if(!ownerId) return;
                    try{
                        const res = await fetch('/api/conversation', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ owner_id: parseInt(ownerId,10) }) });
                        const data = await res.json();
                        if(data && data.success){
                            conversationId = data.conversation_id;
                            // update URL without reload
                            const u = new URL(window.location);
                            u.searchParams.set('conversation_id', conversationId);
                            window.history.replaceState({}, '', u);
                            await loadMessages();
                        } else {
                            alert(data.message || 'Failed to create conversation');
                        }
                    } catch(e){ console.error(e); }
                });
            });

            sendBtn.addEventListener('click', sendMessage);
            msgInput.addEventListener('keydown', e => { if(e.key === 'Enter') sendMessage(); });

            // initial load if conversation_id in url
            if(conversationId) loadMessages();
            // poll for new messages every 3 seconds while a conversation is open
            setInterval(() => { if(conversationId) loadMessages(); }, 3000);
        })();
    </script>
</body>
</html>